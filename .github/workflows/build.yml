name: Build Multi-Platform Libraries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.config.name }} (${{ matrix.build_type }})
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { name: 'Windows-x64', os: windows-latest, arch: 'x64', preset: 'x64-windows-vcpkg' }
          - { name: 'Windows-x86', os: windows-latest, arch: 'x86', preset: 'x86-windows-vcpkg' }
          - { name: 'Windows-arm64', os: windows-latest, arch: 'arm64', preset: 'arm64-windows-vcpkg', cross: true }
          - { name: 'Ubuntu-x64', os: ubuntu-latest, arch: 'x64', preset: 'linux-x64-gcc' }
          - { name: 'Ubuntu-x86', os: ubuntu-latest, arch: 'x86', preset: 'linux-x86-gcc' }
          - { name: 'Ubuntu-arm64', os: ubuntu-latest, arch: 'arm64', preset: 'linux-arm64-gcc', cross: true }
          - { name: 'macOS-arm64', os: macos-latest, arch: 'arm64', preset: 'macos-arm64-gcc' }
        build_type: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies and bundle JS
        run: |
          pnpm install
          npx webpack

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.21.x'

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libcurl4-openssl-dev gcc-multilib g++-multilib

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          echo "macOS自带 curl 和 pkg-config，无需安装"

      - name: Install Windows dependencies (vcpkg)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.bat
          ./vcpkg/vcpkg install --classic --recurse curl:x64-windows curl:x86-windows curl:arm64-windows || ./vcpkg/vcpkg install --classic --recurse curl:x64-windows curl:x86-windows curl:arm64-windows

      - name: Configure CMake (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          BUILD_DIR="build-${{ matrix.config.arch }}"
          mkdir -p $BUILD_DIR

          if [ "${{ runner.os }}" = "macOS" ]; then
            cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_C_FLAGS="-O2 -Wall" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          elif [ "${{ matrix.config.arch }}" = "x86" ]; then
            cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_C_FLAGS=-m32 -DCMAKE_CXX_FLAGS=-m32
          elif [ "${{ matrix.config.arch }}" = "arm64" ]; then
            sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=aarch64 -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
          else
            cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_C_FLAGS="-O2 -Wall" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          fi

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        shell: bash
        run: |
          cmake --preset ${{ matrix.config.preset }}

      - name: Build
        run: |
          BUILD_DIR="build-${{ matrix.config.arch }}"
          if [ "${{ runner.os }}" = "Windows" ]; then
            cmake --build $BUILD_DIR --config ${{ matrix.build_type }} -- /m
          else
            cmake --build $BUILD_DIR --config ${{ matrix.build_type }} -j$(nproc)
          fi

      - name: Prepare artifacts
        shell: bash
        run: |
          ARTIFACT_NAME="kugou_music_api-${{ matrix.config.name }}-${{ matrix.build_type }}"
          BUILD_DIR="${{ runner.os == 'Windows' && 'build-' + matrix.config.arch || 'build' }}"
          mkdir -p $ARTIFACT_NAME/{static,shared,include}

          # Copy static library
          if [ "${{ runner.os }}" = "Windows" ]; then
            if [ "${{ matrix.build_type }}" = "Release" ]; then
              cp $BUILD_DIR/Release/kugou_music_api_static.lib $ARTIFACT_NAME/static/ 2>/dev/null || cp $BUILD_DIR/libkugou_music_api_static.lib $ARTIFACT_NAME/static/ 2>/dev/null || true
            else
              cp $BUILD_DIR/Debug/kugou_music_api_static.lib $ARTIFACT_NAME/static/ 2>/dev/null || cp $BUILD_DIR/libkugou_music_api_static.lib $ARTIFACT_NAME/static/ 2>/dev/null || true
            fi
          else
            cp $BUILD_DIR/libkugou_music_api_static.a $ARTIFACT_NAME/static/ 2>/dev/null || true
          fi

          # Copy shared library
          if [ "${{ runner.os }}" = "Windows" ]; then
            if [ "${{ matrix.build_type }}" = "Release" ]; then
              cp $BUILD_DIR/Release/kugou_music_api.dll $ARTIFACT_NAME/shared/ 2>/dev/null || cp $BUILD_DIR/kugou_music_api.dll $ARTIFACT_NAME/shared/ 2>/dev/null || true
              cp $BUILD_DIR/Release/kugou_music_api.lib $ARTIFACT_NAME/shared/ 2>/dev/null || cp $BUILD_DIR/libkugou_music_api.lib $ARTIFACT_NAME/shared/ 2>/dev/null || true
            else
              cp $BUILD_DIR/Debug/kugou_music_api.dll $ARTIFACT_NAME/shared/ 2>/dev/null || cp $BUILD_DIR/kugou_music_api.dll $ARTIFACT_NAME/shared/ 2>/dev/null || true
              cp $BUILD_DIR/Debug/kugou_music_api.lib $ARTIFACT_NAME/shared/ 2>/dev/null || cp $BUILD_DIR/libkugou_music_api.lib $ARTIFACT_NAME/shared/ 2>/dev/null || true
            fi
          elif [ "${{ runner.os }}" = "macOS" ]; then
            cp $BUILD_DIR/libkugou_music_api.dylib $ARTIFACT_NAME/shared/ 2>/dev/null || true
          else
            cp $BUILD_DIR/libkugou_music_api.so $ARTIFACT_NAME/shared/ 2>/dev/null || true
          fi

          # Copy headers
          cp -r src/include/* $ARTIFACT_NAME/include/

          # Create archive
          cd $ARTIFACT_NAME
          if [ "${{ runner.os }}" = "Windows" ]; then
            7z a ../$ARTIFACT_NAME.zip *
          else
            tar -czf ../$ARTIFACT_NAME.tar.gz *
          fi
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kugou_music_api-${{ matrix.config.name }}-${{ matrix.build_type }}
          path: |
            kugou_music_api-${{ matrix.config.name }}-${{ matrix.build_type }}.zip
            kugou_music_api-${{ matrix.config.name }}-${{ matrix.build_type }}.tar.gz
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.zip,artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
